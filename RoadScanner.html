<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <meta http-equiv="pragma" content="no-cache" />

    <title>RoadScanner</title>
    
    <style>

        html {
            position: relative;
            min-height: 100%;
        }
        body {
            margin: 0px;
            background: Gray;
            padding: 1px;
        }

        .container {
            border: solid Black 1px;  
            position: absolute;  
            padding: 5px;            
        }

        #left {
            background: LightYellow;
            top:0px;
            bottom:0px;
            left:0px;
            width:200px;
        }

        #main {
            background: SkyBlue;
            top: 0px;
            bottom: 0px;
            left: 200px;
            right:0px;
        }

        #map-canvas {
            position: relative;
            height: 100%; 
            width: 100%;           
        }

    </style>

    <script src="https://maps.googleapis.com/maps/api/js?v=3"></script>

    <script src="polyline.js"></script>

    <script>
        
        function doConnect() {
            websocket = new WebSocket("ws://localhost:8000/");
            websocket.onopen = function(event) { onOpen(event) };
            websocket.onclose = function(event) { onClose(event) };
            websocket.onmessage = function(event) { onMessage(event) };
            websocket.onerror = function(event) { onError(event) };
        }

        function doDisconnect() {
            websocket.close();
        }        


        function onOpen(event) {
            console.log("connected");
        }

        function onClose(event) {
            console.log("disconnected");
        }

        function onMessage(event) {
            console.log(event.data);
        }

        function onError(event) {
            console.log('error: ' + event.data);
            websocket.close();
        }


        function Send(message) {
            websocket.send(message);
        }

    </script>

    <script>

        var map;
        var dService;
        var dRenderer;

        var polyline = [];        
        var start;
        var end;

        function initialize() {

            // Map
            var mapOptions = {                
                mapTypeId: google.maps.MapTypeId.HYBRID,
                center: {lat: -30, lng: -51.2},
                zoom: 7
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), 
                mapOptions);


            // Service
            dService =  new google.maps.DirectionsService();        

            // Renderer
            dRenderer = new google.maps.DirectionsRenderer(
            {
                draggable: true
            });

            dRenderer.setMap(map);


            // Events
            google.maps.event.addListener(map, "click", function(event)
            {
                click(event.latLng);
            });    

            google.maps.event.addListener(dRenderer, "directions_changed", function(event)
            {
                updatePolyline();
            });     


            doConnect();       

        }


        function click(location) {
            console.log("clicked")

            if (typeof start == 'undefined') {
                start = location;
                return;
            }

            else
            if (typeof end == 'undefined') {
                end = location;
                console.log("clicked second point")
                calcRoute();
            }            
            else
            {
                calcRoute();
            }
        }   



        function calcRoute() {

            var request = {
                origin:start,
                destination:end,
                travelMode: google.maps.TravelMode.DRIVING,
                provideRouteAlternatives : false
            };

            dService.route(request, function(dResult, status) {
                if (status == google.maps.DirectionsStatus.OK) {                    
                    dRenderer.setDirections(dResult);
                }
            });
        }


        function updatePolyline()
        {
            coordinates = [];

            var route = dRenderer.getDirections().routes[0];
            var legs = route.legs

            for (var i = 0; i < legs.length; i++)
            {
                var leg = legs[i];
                var steps = leg.steps;

                for (var j = 0; j < steps.length; j++)
                {
                    var step = steps[j];
                    var points = step.polyline.points

                    coordinates.push.apply(coordinates, (decode(points)));
                }
            }

            addPolylineToMap(coordinates);

            var message = lineString(coordinates);

            //alert(message);

            Send(message);
        }

        function addPolylineToMap(coordinates) {

            var latlngs = [];
            for (var i = 0; i < coordinates.length; i++) {
                var c = coordinates[i];
                latlngs.push({lat: c[0], lng: c[1]})
            }

            var polyline = new google.maps.Polyline({
                path: latlngs,
                geodesic: true,
                strokeColor: '#FF0000',
                strokeOpacity: 0.5,
                strokeWeight: 2
            });

            polyline.setMap(map);            
        }

        function lineString(coordinates)     
        {
            var coords = [];
            for (var i = 0; i < coordinates.length; i++)
            {
                var c = coordinates[i];
                coords.push([c[1], c[0]]);
            }
            return coords.join(" ");
        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>

<body>
    <div id="left" class="container">
        <form title="Controles">

        </form>
    </div>

    <div id="main" class="container">
        <div id="map-canvas"></div>
    </div>

</body>
</html>
